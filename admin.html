<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Administração</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script>
  // Configuração Firebase (mesma usada no seu index.html)
  const firebaseConfig = { /* ... sua config ... */ };
  firebase.initializeApp(firebaseConfig);
</script>
</head>
<body class="p-3">

<div class="container">
  <h2 class="mb-3">Administração – Usuários</h2>
  <button id="exportExcel" class="btn btn-primary mb-3">Exportar Excel</button>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Email</th>
        <th>Status</th>
        <th>Ação</th>
      </tr>
    </thead>
    <tbody id="userList"></tbody>
  </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
firebase.auth().onAuthStateChanged(user => {
  if (!user || user.email !== 'alansrocha@gmail.com') {
    document.body.innerHTML = '<h4 class="p-3">Acesso negado</h4>';
    return;
  }
  loadUsers();
});

async function loadUsers() {
  const snapshot = await firebase.firestore().collection('users').get();
  const tbody = document.getElementById('userList');
  tbody.innerHTML = "";
  snapshot.forEach(doc => {
    const data = doc.data();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${data.name || ''}</td>
      <td>${data.email}</td>
      <td>${data.revoked ? 'Revogado' : 'Ativo'}</td>
      <td>
        <button class="btn btn-sm ${data.revoked ? 'btn-success' : 'btn-danger'}"
                onclick="toggleAccess('${doc.id}', ${!data.revoked})">
          ${data.revoked ? 'Restaurar' : 'Revogar'}
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function toggleAccess(uid, revoke) {
  await firebase.firestore().collection('users').doc(uid).update({ revoked: revoke });
  loadUsers();
}

document.getElementById('exportExcel').addEventListener('click', async () => {
  const snapshot = await firebase.firestore().collection('users').get();
  const users = [];
  snapshot.forEach(doc => users.push(doc.data()));
  const ws = XLSX.utils.json_to_sheet(users);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Usuários");
  XLSX.writeFile(wb, 'usuarios.xlsx');
});
</script>

</body>
</html>
