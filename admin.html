<!DOCTYPE html>
<html lang="pt-BR">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#003366">
<link rel="icon" href="icon-192.png" type="image/png">
<link rel="apple-touch-icon" href="icon-192.png">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Quilometragem</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- XLSX (Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg: #f7f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted:#6b7280;
      --primary:#2563eb;
      --border:#e5e7eb;
      --grid: rgba(0,0,0,.08);
    }
    [data-theme="dark"]{
      --bg:#101216;
      --card:#171a21;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --primary:#60a5fa;
      --border:#252a33;
      --grid: rgba(255,255,255,.12);
    }

    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      line-height:1.35;
    }
    .container{max-width:980px;margin:0 auto;padding:16px}
    h1{margin:14px 0 10px;text-align:center;font-size:1.5rem}
    h2{margin:8px 0 14px;font-size:1.1rem;text-align:center}
    .card{
      background:var(--card);border:1px solid var(--border);
      border-radius:14px; padding:14px; margin:12px 0 18px;
      box-shadow:0 6px 18px rgba(0,0,0,.05);
    }
    label{display:block;margin:8px 0 6px;font-weight:600;font-size:.95rem}
    input,select,textarea{
      width:100%;padding:10px 12px;border:1px solid var(--border);
      border-radius:10px;background:transparent;color:var(--text);font-size:.95rem;
      outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:var(--primary)}
    textarea{min-height:80px;resize:vertical}

    /* Botões compactos */
    .actions{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-start}
    .btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;font-size:.9rem;font-weight:700;
      background:var(--primary);color:#fff;border:0;border-radius:10px;
      cursor:pointer;transition:transform .1s ease,opacity .2s ease;
    }
    .btn:hover{opacity:.9;transform:translateY(-1px)}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
    .btn.small{padding:6px 10px;font-weight:600}

    img.preview{max-width:120px;border-radius:8px;margin-top:6px;border:1px solid var(--border)}

    /* Relatórios */
    .relatorio{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      padding:10px;border:1px solid var(--border);border-radius:10px;margin-top:10px;flex-wrap:wrap;
      background:var(--card);
    }
    .relatorio-info{font-size:.92rem}
    .relatorio img{max-height:80px}

    /* Dashboard */
    .filters{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px}
    .filters select{flex:1;min-width:160px}
    .metrics{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-bottom:12px}
    .metric{
      border:1px solid var(--border);border-radius:12px;padding:10px;text-align:center;background:var(--card)
    }
    .metric h3{margin:0;color:var(--muted);font-size:.9rem;font-weight:700}
    .metric p{margin:6px 0 0;color:var(--primary);font-size:1.25rem;font-weight:800}

    canvas{width:100%!important;height:300px!important}

    /* Botão de contraste fixo, apenas ícone */
    .theme-toggle{
      position:fixed;top:10px;right:10px;z-index:9999;
      background:transparent;border:none;color:var(--text);
      font-size:22px;cursor:pointer;padding:0;line-height:1;
    }
    .theme-toggle:hover{opacity:.7}

    @media (max-width:640px){
      .metrics{grid-template-columns:1fr}
      .actions{justify-content:stretch}
      .btn{flex:1}
    }
  </style>
</head>
<body>
<div class="container p-3">
  <h2>Administração – Usuários</h2>
  <button id="exportExcel" class="btn mb-3">Exportar Excel</button>
  <table class="table">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Email</th>
        <th>Status</th>
        <th>Ação</th>
      </tr>
    </thead>
    <tbody id="userList"></tbody>
  </table>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
firebase.auth().onAuthStateChanged(user => {
  if (!user || user.email !== 'alansrocha@gmail.com') {
    document.body.innerHTML = '<h4 class="p-3">Acesso negado</h4>';
    return;
  }
  loadUsers();
});

async function loadUsers() {
  const snapshot = await firebase.firestore().collection('users').get();
  const tbody = document.getElementById('userList');
  tbody.innerHTML = "";
  snapshot.forEach(doc => {
    const data = doc.data();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${{data.name || ''}}</td>
      <td>${{data.email}}</td>
      <td>${{data.revoked ? 'Revogado' : 'Ativo'}}</td>
      <td>
        <button class="btn small" onclick="toggleAccess('${{doc.id}}', ${{!data.revoked}})">
          ${{data.revoked ? 'Restaurar' : 'Revogar'}}
        </button>
      </td>
`;
    tbody.appendChild(tr);
  });
}

async function toggleAccess(uid, revoke) {
  await firebase.firestore().collection('users').doc(uid).update({ revoked: revoke });
  loadUsers();
}

document.getElementById('exportExcel').addEventListener('click', async () => {
  const snapshot = await firebase.firestore().collection('users').get();
  const users = [];
  snapshot.forEach(doc => users.push(doc.data()));
  const ws = XLSX.utils.json_to_sheet(users);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Usuários");
  XLSX.writeFile(wb, 'usuarios.xlsx');
});
</script>
</body>
</html>