<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle KM</title>
<link rel="stylesheet" href="styles.css">
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
</head>
<body>
<div id="mainContent">
    <h1>Painel Principal</h1>
    <button id="adminBtn" style="display:none;">Administração</button>
</div>

<div id="adminPanel" style="display:none;">
    <h2>Administração – Usuários</h2>
    <button id="exportExcel">Exportar Excel</button>
    <button id="backBtn">Voltar</button>
    <table border="1">
        <thead>
            <tr><th>Nome</th><th>Email</th><th>Status</th><th>Ação</th></tr>
        </thead>
        <tbody id="userList"></tbody>
    </table>
</div>

<script>
// Config Firebase
const firebaseConfig = {
  // SUA CONFIG FIREBASE
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Mostrar botão admin apenas se for admin
auth.onAuthStateChanged(user => {
    if(user) {
        db.collection("users").doc(user.uid).get().then(doc => {
            if(doc.exists && doc.data().role === "admin") {
                document.getElementById("adminBtn").style.display = "block";
            }
        });
    }
});

// Clique no botão admin
document.getElementById("adminBtn").addEventListener("click", () => {
    document.getElementById("mainContent").style.display = "none";
    document.getElementById("adminPanel").style.display = "block";
    loadUsers();
});

// Voltar
document.getElementById("backBtn").addEventListener("click", () => {
    document.getElementById("adminPanel").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
});

// Carregar usuários
function loadUsers(){
    const tbody = document.getElementById("userList");
    tbody.innerHTML = "";
    db.collection("users").get().then(snapshot => {
        snapshot.forEach(doc => {
            const data = doc.data();
            if(data.revoked === undefined){
                db.collection("users").doc(doc.id).update({ revoked: false });
            }
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${data.name || ""}</td>
                <td>${data.email}</td>
                <td>${data.revoked ? "Revogado" : "Ativo"}</td>
                <td>
                    <button onclick="toggleAccess('${doc.id}', ${!data.revoked})">
                        ${data.revoked ? "Restaurar" : "Revogar"}
                    </button>
                </td>`;
            tbody.appendChild(tr);
        });
    });
}

// Alternar acesso
function toggleAccess(uid, revoke){
    db.collection("users").doc(uid).update({ revoked: revoke }).then(loadUsers);
}

// Exportar Excel
document.getElementById("exportExcel").addEventListener("click", () => {
    let csv = "Nome,Email,Status\n";
    document.querySelectorAll("#userList tr").forEach(row => {
        const cols = row.querySelectorAll("td");
        csv += Array.from(cols).map(td => td.innerText).join(",") + "\n";
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "usuarios.csv";
    link.click();
});
</script>
</body>
</html>
