<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Quilometragem</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007bff">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query, where, orderBy, deleteDoc, serverTimestamp, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCNUTWw3BLTg3S2KPqsnCfZC_aw5lqidas",
      authDomain: "controle-de-km-86510.firebaseapp.com",
      projectId: "controle-de-km-86510",
      storageBucket: "controle-de-km-86510.firebasestorage.app",
      messagingSenderId: "608090510388",
      appId: "1:608090510388:web:3b31393fb0a80ba243a661",
      measurementId: "G-HW52GZV66K"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Disponibilizar globalmente
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.firebaseAuthMethods = { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged };
    window.firebaseDbMethods = { doc, setDoc, getDoc, collection, getDocs, query, where, orderBy, deleteDoc, serverTimestamp, writeBatch };
  </script>

  <style>
    :root {
      --bg-color: #f4f4f9;
      --text-color: #333;
      --card-bg: #fff;
      --primary-color: #007bff;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
    }
    [data-theme="dark"] {
      --bg-color: #1e1e1e;
      --text-color: #f4f4f9;
      --card-bg: #2c2c2c;
      --primary-color: #0d6efd;
    }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
    }
    .container {
      max-width: 900px;
      margin: auto;
    }
    .card {
      background: var(--card-bg);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    input, button, select {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
    }
    button {
      background: var(--primary-color);
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.9;
    }
    /* Bot√µes menores */
    .btn-small {
      padding: 6px 12px;
      width: auto;
      display: inline-block;
      margin: 2px;
      font-size: 12px;
    }
    .btn-danger {
      background: var(--danger-color);
    }
    .btn-success {
      background: var(--success-color);
    }
    .btn-warning {
      background: var(--warning-color);
      color: #000;
    }
    .btn-admin {
      background: var(--warning-color);
      color: #000;
    }
    img {
      max-width: 100px;
      margin-top: 5px;
      display: block;
    }
    .relatorio {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--card-bg);
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
    }
    canvas {
      max-width: 100%;
      height: 250px !important;
    }
    /* Cart√µes de m√©tricas */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .metric-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    .metric-value {
      font-size: 2em;
      font-weight: bold;
      color: var(--primary-color);
    }
    .metric-label {
      font-size: 0.9em;
      color: var(--text-color);
      opacity: 0.7;
    }
    /* Filtros */
    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .filters select, .filters input {
      flex: 1;
      min-width: 150px;
    }

    /* Bot√£o de tema fixo - CORRIGIDO */
    .theme-toggle {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 9999;
      background: transparent;
      border: none;
      padding: 8px;
      cursor: pointer;
      color: var(--primary-color);
      font-size: 20px;
      transition: all 0.3s;
      width: auto !important;
      min-width: auto !important;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .theme-toggle:hover {
      background: var(--primary-color);
      color: white;
    }

    /* Campos obrigat√≥rios */
    .required {
      border-color: var(--danger-color) !important;
    }
    .required-label::after {
      content: " *";
      color: var(--danger-color);
    }
    /* Fotos no relat√≥rio */
    .foto-relatorio {
      max-width: 60px;
      max-height: 100px;
      object-fit: cover;
      border-radius: 4px;
      margin: 2px;
    }

    /* Estilos de autentica√ß√£o */
    .auth-container {
      max-width: 400px;
      margin: 50px auto;
      padding: 20px;
    }
    .auth-tabs {
      display: flex;
      margin-bottom: 20px;
    }
    .auth-tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      border: 1px solid #ccc;
      background: var(--card-bg);
    }
    .auth-tab.active {
      background: var(--primary-color);
      color: white;
    }
    .auth-form {
      display: none;
    }
    .auth-form.active {
      display: block;
    }
    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 10px;
      background: var(--card-bg);
      border-radius: 8px;
    }

    /* Tabela de administra√ß√£o */
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    .admin-table th, .admin-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .admin-table th {
      background: var(--primary-color);
      color: white;
    }
    .admin-table tr:nth-child(even) {
      background: rgba(0,0,0,0.05);
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .filters {
        flex-direction: column;
      }
      .metrics-grid {
        grid-template-columns: 1fr 1fr;
      }
      .auth-container {
        margin: 20px auto;
        padding: 15px;
      }
      /* Ajustar bot√£o de tema no mobile */
      .theme-toggle {
        top: 5px;
        right: 5px;
        font-size: 18px;
      }
    }

    /* Ocultar conte√∫do principal quando n√£o logado */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <button id="themeToggle" class="theme-toggle">üåô</button>

  <!-- Tela de Autentica√ß√£o -->
  <div id="authScreen" class="auth-container">
    <div class="card">
      <h1>Controle de Quilometragem</h1>
      <div class="auth-tabs">
        <div class="auth-tab active" onclick="switchAuthTab(\'login\')">Login</div>
        <div class="auth-tab" onclick="switchAuthTab(\'register\')">Cadastro</div>
      </div>

      <!-- Formul√°rio de Login -->
      <div id="loginForm" class="auth-form active">
        <input type="email" id="loginEmail" placeholder="Email" required>
        <input type="password" id="loginPassword" placeholder="Senha" required>
        <button onclick="login()" class="btn-success">Entrar</button>
      </div>

      <!-- Formul√°rio de Cadastro -->
      <div id="registerForm" class="auth-form">
        <input type="email" id="registerEmail" placeholder="Email" required>
        <input type="password" id="registerPassword" placeholder="Senha (m√≠n. 6 caracteres)" required>
        <input type="text" id="registerName" placeholder="Nome completo" required>
        <button onclick="register()" class="btn-success">Cadastrar</button>
      </div>

      <div id="authMessage" style="margin-top: 15px; text-align: center;"></div>
    </div>
  </div>

  <!-- Conte√∫do Principal (oculto at√© login) -->
  <div id="mainContent" class="container hidden">
    <!-- Informa√ß√µes do usu√°rio logado -->
    <div class="user-info">
      <div>
        <strong>Usu√°rio:</strong> <span id="userEmail"></span>
        <div id="adminButton" class="hidden" style="margin-top: 5px;">
          <button onclick="toggleAdminPanel()" class="btn-small btn-admin">üëë Administrador</button>
        </div>
      </div>
      <button onclick="logout()" class="btn-small btn-danger">Sair</button>
    </div>

    <h1>Controle de Quilometragem</h1>

    <div class="card">
      <h2>Novo Registro</h2>
      
      <label class="required-label">Placa do Ve√≠culo</label>
      <input type="text" id="placaVeiculo" placeholder="Ex: ABC-1234" maxlength="8" required>
      
      <label>Data e Hora (Bras√≠lia):</label>
      <input type="text" id="dataHora" readonly>
      
      <label class="required-label">Quilometragem Inicial</label>
      <input type="number" id="kmInicial" required>
      <label class="required-label">Foto Inicial</label>
      <input type="file" id="fotoInicial" accept="image/*" required>
      <img id="previewInicial">

      <label class="required-label">Quilometragem Final</label>
      <input type="number" id="kmFinal" required>
      <label class="required-label">Foto Final</label>
      <input type="file" id="fotoFinal" accept="image/*" required>
      <img id="previewFinal">

      <button onclick="salvarRegistro()" class="btn-success">üíæ Salvar</button>
    </div>

    <!-- Cart√µes de M√©tricas -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-value" id="totalKm">0</div>
        <div class="metric-label">Km Total</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="mediaKm">0</div>
        <div class="metric-label">Km M√©dio</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="totalViagens">0</div>
        <div class="metric-label">Total de Viagens</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="maiorViagem">0</div>
        <div class="metric-label">Maior Viagem (Km)</div>
      </div>
    </div>

    <div class="card">
      <h2>Relat√≥rios</h2>
      <div class="filters">
        <select id="filtroPer√≠odo">
          <option value="todos">Todos os per√≠odos</option>
          <option value="hoje">Hoje</option>
          <option value="semana">Esta semana</option>
          <option value="mes">Este m√™s</option>
          <option value="personalizado">Per√≠odo personalizado</option>
        </select>
        <select id="filtroPlaca">
          <option value="todas">Todas as placas</option>
        </select>
        <input type="date" id="dataInicio" style="display:none;">
        <input type="date" id="dataFim" style="display:none;">
        <button onclick="aplicarFiltro()" class="btn-small">üîç Filtrar</button>
      </div>
      <div id="relatorios"></div>
      <div style="text-align: center; margin-top: 15px;">
        <button onclick="exportarXLSX()" class="btn-small btn-warning">üìÇ Exportar</button>
        <button onclick="apagarTodos()" class="btn-small btn-danger">üóëÔ∏è Apagar Todos</button>
      </div>
    </div>

    <div class="card">
      <h2>Dashboard</h2>
      <canvas id="grafico"></canvas>
    </div>

    <!-- Painel Administrativo -->
    <div id="adminPanel" class="card hidden">
      <h2>Painel Administrativo</h2>
      <div style="text-align: center; margin-bottom: 15px;">
        <button onclick="loadUsers()" class="btn-small btn-success">üîÑ Atualizar Lista</button>
        <button onclick="exportUsersToExcel()" class="btn-small btn-warning">üìÇ Exportar Usu√°rios</button>
      </div>
      <div id="usersTableContainer">
        <table class="admin-table" id="usersTable">
          <thead>
            <tr>
              <th>Email</th>
              <th>Nome</th>
              <th>Fun√ß√£o</th>
              <th>Data de Cadastro</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr>
              <td colspan="4" style="text-align: center;">Clique em "Atualizar Lista" para carregar os usu√°rios</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let isAdmin = false;
    let allMileageRecords = []; // Armazena todos os registros do Firestore

    // Vari√°veis do app principal
    const dataHoraInput = document.getElementById("dataHora");
    const relatoriosDiv = document.getElementById("relatorios");
    let registros = []; // Agora ser√° preenchido pelo Firestore
    let registrosFiltrados = [];

    // Aguardar carregamento do Firebase
    window.addEventListener(\'load\', () => {
      setTimeout(() => {
        initializeAuth();
      }, 1000);
    });

    function initializeAuth() {
      if (window.firebaseAuth && window.firebaseAuthMethods) {
        window.firebaseAuthMethods.onAuthStateChanged(window.firebaseAuth, async (user) => {
          if (user) {
            currentUser = user;
            isAdmin = user.email === \'alansrocha@gmail.com\';
            
            // Tentar buscar o documento do usu√°rio no Firestore para garantir que existe
            const userDocRef = window.firebaseDbMethods.doc(window.firebaseDb, \'users\', user.uid);
            const userDocSnap = await window.firebaseDbMethods.getDoc(userDocRef);

            if (!userDocSnap.exists()) {
              console.warn(\'Documento do usu√°rio n√£o encontrado no Firestore para UID:\', user.uid, \'Criando agora...\');
              // Se o documento n√£o existe, cria-o (pode acontecer se o cadastro falhou na primeira vez)
              try {
                await window.firebaseDbMethods.setDoc(userDocRef, {
                  email: user.email,
                  name: user.displayName || \'Usu√°rio Novo\',
                  role: user.email === \'alansrocha@gmail.com\' ? \'admin\' : \'user\',
                  createdAt: window.firebaseDbMethods.serverTimestamp(),
                  revoked: false
                });
                console.log(\'Documento do usu√°rio criado no Firestore durante onAuthStateChanged.\');
              } catch (error) {
                console.error(\'Erro ao criar documento do usu√°rio no Firestore durante onAuthStateChanged:\', error);
              }
            }

            showMainContent();
          } else {
            currentUser = null;
            isAdmin = false;
            showAuthScreen();
          }
        });
      }
    }

    function showAuthScreen() {
      document.getElementById(\'authScreen\').classList.remove(\'hidden\');
      document.getElementById(\'mainContent\').classList.add(\'hidden\');
    }

    function showMainContent() {
      document.getElementById(\'authScreen\').classList.add(\'hidden\');
      document.getElementById(\'mainContent\').classList.remove(\'hidden\');
      
      // Atualizar informa√ß√µes do usu√°rio
      document.getElementById(\'userEmail\').textContent = currentUser.email;
      
      // Mostrar bot√£o admin se for administrador
      if (isAdmin) {
        document.getElementById(\'adminButton\').classList.remove(\'hidden\');
      } else {
        document.getElementById(\'adminButton\').classList.add(\'hidden\');
      }

      // Inicializar app principal
      initializeMainApp();
    }

    function switchAuthTab(tab) {
      document.querySelectorAll(\'.auth-tab\').forEach(t => t.classList.remove(\'active\'));
      document.querySelectorAll(\'.auth-form\').forEach(f => f.classList.remove(\'active\'));
      
      if (tab === \'login\') {
        document.querySelector(\'.auth-tab:first-child\').classList.add(\'active\');
        document.getElementById(\'loginForm\').classList.add(\'active\');
      } else {
        document.querySelector(\'.auth-tab:last-child\').classList.add(\'active\');
        document.getElementById(\'registerForm\').classList.add(\'active\');
      }
      
      document.getElementById(\'authMessage\').textContent = \'\';
    }

    async function login() {
      const email = document.getElementById(\'loginEmail\').value;
      const password = document.getElementById(\'loginPassword\').value;
      const messageDiv = document.getElementById(\'authMessage\');

      if (!email || !password) {
        messageDiv.textContent = \'Por favor, preencha todos os campos.\';
        messageDiv.style.color = \'red\';
        return;
      }

      try {
        await window.firebaseAuthMethods.signInWithEmailAndPassword(window.firebaseAuth, email, password);
        messageDiv.textContent = \'Login realizado com sucesso!\';
        messageDiv.style.color = \'green\';
      } catch (error) {
        console.error(\'Erro detalhado no login:\', error);
        messageDiv.textContent = \'Erro no login: \' + error.message;
        messageDiv.style.color = \'red\';
      }
    }

    async function register() {
      const email = document.getElementById(\'registerEmail\').value;
      const password = document.getElementById(\'registerPassword\').value;
      const name = document.getElementById(\'registerName\').value;
      const messageDiv = document.getElementById(\'authMessage\');

      if (!email || !password || !name) {
        messageDiv.textContent = \'Por favor, preencha todos os campos.\';
        messageDiv.style.color = \'red\';
        return;
      }

      if (password.length < 6) {
        messageDiv.textContent = \'A senha deve ter pelo menos 6 caracteres.\';
        messageDiv.style.color = \'red\';
        return;
      }

      try {
        console.log(\'Iniciando cadastro para:\', email);
        messageDiv.textContent = \'Criando conta...\';
        messageDiv.style.color = \'blue\';

        // Criar usu√°rio no Firebase Auth
        const userCredential = await window.firebaseAuthMethods.createUserWithEmailAndPassword(window.firebaseAuth, email, password);
        const user = userCredential.user;
        
        console.log(\'Usu√°rio criado no Auth:\', user.uid);
        messageDiv.textContent = \'Salvando dados do usu√°rio no Firestore...\';

        // Preparar dados do usu√°rio
        const userData = {
          email: email,
          name: name,
          role: email === \'alansrocha@gmail.com\' ? \'admin\' : \'user\',
          createdAt: window.firebaseDbMethods.serverTimestamp(),
          revoked: false
        };

        console.log(\'Dados a serem salvos no Firestore:\', userData);

        // Salvar dados do usu√°rio no Firestore
        const userDocRef = window.firebaseDbMethods.doc(window.firebaseDb, \'users\', user.uid);
        await window.firebaseDbMethods.setDoc(userDocRef, userData);
        
        console.log(\'Documento do usu√°rio salvo no Firestore com sucesso para UID:\', user.uid);
        
        messageDiv.textContent = \'Cadastro realizado com sucesso!\';
        messageDiv.style.color = \'green\';

        // Limpar formul√°rio
        document.getElementById(\'registerEmail\').value = \'\';
        document.getElementById(\'registerPassword\').value = \'\';
        document.getElementById(\'registerName\').value = \'\';

      } catch (error) {
        console.error(\'Erro detalhado no cadastro:\', error);
        console.error(\'C√≥digo do erro:\', error.code);
        console.error(\'Mensagem do erro:\', error.message);
        
        let errorMessage = \'Erro no cadastro: \';
        
        switch(error.code) {
          case \'auth/email-already-in-use\':
            errorMessage += \'Este email j√° est√° em uso.\';
            break;
          case \'auth/invalid-email\':
            errorMessage += \'Email inv√°lido.\';
            break;
          case \'auth/weak-password\':
            errorMessage += \'Senha muito fraca.\';
            break;
          default:
            errorMessage += error.message;
        }
        
        messageDiv.textContent = errorMessage;
        messageDiv.style.color = \'red\';
      }
    }

    async function logout() {
      try {
        await window.firebaseAuthMethods.signOut(window.firebaseAuth);
      } catch (error) {
        console.error(\'Erro ao fazer logout:\', error);
      }
    }

    function toggleAdminPanel() {
      const panel = document.getElementById(\'adminPanel\');
      panel.classList.toggle(\'hidden\');
    }

    async function loadUsers() {
      if (!isAdmin) {
        alert(\'Acesso negado. Apenas administradores podem ver esta lista.\');
        return;
      }

      try {
        console.log(\'Carregando usu√°rios...\');
        const usersCollection = window.firebaseDbMethods.collection(window.firebaseDb, \'users\');
        const snapshot = await window.firebaseDbMethods.getDocs(usersCollection);
        
        console.log(\'Snapshot obtido:\', snapshot);
        console.log(\'N√∫mero de documentos:\', snapshot.size);
        
        const tbody = document.getElementById(\'usersTableBody\');
        tbody.innerHTML = \'\';

        if (snapshot.empty) {
          tbody.innerHTML = \'<tr><td colspan="4" style="text-align: center;">Nenhum usu√°rio encontrado</td></tr>\';
          console.log(\'Nenhum usu√°rio encontrado no Firestore\');
          return;
        }

        let userCount = 0;
        snapshot.forEach((doc) => {
          userCount++;
          const userData = doc.data();
          console.log(`Usu√°rio ${userCount}:`, userData);
          
          const row = tbody.insertRow();
          
          row.insertCell(0).textContent = userData.email || \'\';
          row.insertCell(1).textContent = userData.name || \'\';
          row.insertCell(2).textContent = userData.role || \'user\';
          
          // Tratar data de cria√ß√£o
          let dateText = \'\';
          if (userData.createdAt) {
            try {
              if (userData.createdAt.toDate) {
                dateText = userData.createdAt.toDate().toLocaleDateString(\'pt-BR\');
              } else {
                dateText = new Date(userData.createdAt).toLocaleDateString(\'pt-BR\');
              }
            } catch (e) {
              dateText = \'Data inv√°lida\';
            }
          }
          row.insertCell(3).textContent = dateText;
        });
        
        console.log(`Total de usu√°rios carregados: ${userCount}`);
        
      } catch (error) {
        console.error(\'Erro detalhado ao carregar usu√°rios:\', error);
        alert(\'Erro ao carregar usu√°rios: \' + error.message);
      }
    }

    function exportUsersToExcel() {
      const table = document.getElementById(\'usersTable\');
      const rows = Array.from(table.rows);
      
      const data = rows.map(row => {
        const cells = Array.from(row.cells);
        return cells.map(cell => cell.textContent);
      });

      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Usu√°rios");
      XLSX.writeFile(wb, "usuarios_cadastrados.xlsx");
    }

    async function loadMileageRecords() {
      if (!currentUser) return; // N√£o carrega se n√£o houver usu√°rio logado

      try {
        let q;
        if (isAdmin) {
          // Admin v√™ todos os registros
          q = window.firebaseDbMethods.query(
            window.firebaseDbMethods.collection(window.firebaseDb, \'mileageRecords\'),
            window.firebaseDbMethods.orderBy(\'timestamp\', \'desc\')
          );
          console.log(\'Admin: carregando TODOS os registros de quilometragem...\');
        } else {
          // Usu√°rio comum v√™ apenas seus pr√≥prios registros
          q = window.firebaseDbMethods.query(
            window.firebaseDbMethods.collection(window.firebaseDb, \'mileageRecords\'),
            window.firebaseDbMethods.where(\'userId\', \'==\', currentUser.uid),
            window.firebaseDbMethods.orderBy(\'timestamp\', \'desc\')
          );
          console.log(\'Usu√°rio comum: carregando apenas registros pr√≥prios...\');
        }

        const querySnapshot = await window.firebaseDbMethods.getDocs(q);
        allMileageRecords = []; // Limpa os registros anteriores
        querySnapshot.forEach((doc) => {
          allMileageRecords.push({ id: doc.id, ...doc.data() });
        });
        registros = [...allMileageRecords]; // Atualiza a vari√°vel global de registros
        console.log(`Registros de quilometragem carregados do Firestore (${isAdmin ? \'ADMIN\' : \'USER\'}):`, registros.length, \'registros\');
        
        // Se houver dados no localStorage, migrar para o Firestore e limpar localStorage
        const localRegistros = JSON.parse(localStorage.getItem("registros")) || [];
        if (localRegistros.length > 0) {
          console.log(\'Migrando registros do localStorage para Firestore...\');
          for (const rec of localRegistros) {
            // Verifica se o registro j√° existe no Firestore para evitar duplicatas
            const exists = allMileageRecords.some(fr => 
              fr.placa === rec.placa && 
              fr.dataHora === rec.dataHora && 
              fr.kmInicial === rec.kmInicial
            );
            if (!exists) {
              const docRef = window.firebaseDbMethods.doc(window.firebaseDbMethods.collection(window.firebaseDb, \'mileageRecords\'));
              await window.firebaseDbMethods.setDoc(docRef, {
                ...rec,
                userId: currentUser.uid,
                userEmail: currentUser.email, // Adicionado para migra√ß√£o
                timestamp: window.firebaseDbMethods.serverTimestamp()
              });
            }
          }
          localStorage.removeItem("registros");
          console.log(\'Registros do localStorage migrados e localStorage limpo.\');
          // Recarrega os registros do Firestore ap√≥s a migra√ß√£o
          await loadMileageRecords(); 
          return; // Sai da fun√ß√£o para evitar executar o resto duas vezes
        }

        aplicarFiltro(); // Aplica filtro inicial e renderiza
        atualizarFiltroPlacas();
        atualizarMetricas(registrosFiltrados);
        atualizarDashboard();

      } catch (error) {
        console.error(\'Erro ao carregar registros de quilometragem do Firestore:\', error);
        alert(\'Erro ao carregar registros: \' + error.message);
      }
    }

    async function deleteMileageRecord(recordId) {
      if (!confirm("Tem certeza que deseja apagar este registro?")) {
        return;
      }
      try {
        await window.firebaseDbMethods.deleteDoc(window.firebaseDbMethods.doc(window.firebaseDb, \'mileageRecords\', recordId));
        alert(\'Registro apagado com sucesso!\');
        loadMileageRecords(); // Recarrega os registros ap√≥s apagar
      } catch (error) {
        console.error(\'Erro ao apagar registro do Firestore:\', error);
        alert(\'Erro ao apagar registro: \' + error.message);
      }
    }

    async function deleteAllMileageRecords() {
      if (!confirm("Tem certeza que deseja apagar TODOS os registros? Esta a√ß√£o n√£o pode ser desfeita!")) {
        return;
      }
      try {
        let q;
        if (isAdmin) {
          // Admin pode apagar todos os registros
          q = window.firebaseDbMethods.query(
            window.firebaseDbMethods.collection(window.firebaseDb, \'mileageRecords\')
          );
        } else {
          // Usu√°rio comum pode apagar apenas seus pr√≥prios registros
          q = window.firebaseDbMethods.query(
            window.firebaseDbMethods.collection(window.firebaseDb, \'mileageRecords\'),
            window.firebaseDbMethods.where(\'userId\', \'==\', currentUser.uid)
          );
        }
        const querySnapshot = await window.firebaseDbMethods.getDocs(q);
        const batch = window.firebaseDbMethods.writeBatch(window.firebaseDb); // Usar batch para dele√ß√£o em massa
        querySnapshot.forEach((doc) => {
          batch.delete(doc.ref);
        });
        await batch.commit();
        alert(\'Todos os registros apagados com sucesso!\');
        loadMileageRecords(); // Recarrega os registros ap√≥s apagar
      } catch (error) {
        console.error(\'Erro ao apagar todos os registros do Firestore:\', error);
        alert(\'Erro ao apagar todos os registros: \' + error.message);
      }
    }

    function initializeMainApp() {
      // Atualizar data/hora autom√°tica
      function atualizarDataHora() {
        const opcoes = { timeZone: "America/Sao_Paulo", hour12: false };
        dataHoraInput.value = new Date().toLocaleString("pt-BR", opcoes);
      }
      setInterval(atualizarDataHora, 1000);

      // Inicializar
      atualizarDataHora();
      loadMileageRecords(); // Carrega os registros do Firestore
    }

    // Compress√£o de imagens otimizada para 9x16 e mais leve
    function compressImage(file, callback) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          
          // Definir dimens√µes para formato 9x16 (mais leve)
          const maxWidth = 270; // 9 partes
          const maxHeight = 480; // 16 partes
          
          let { width, height } = img;
          
          // Calcular escala mantendo propor√ß√£o 9x16
          const targetRatio = 9/16;
          const currentRatio = width/height;
          
          if (currentRatio > targetRatio) {
            // Imagem muito larga, ajustar pela altura
            height = maxHeight;
            width = height * targetRatio;
          } else {
            // Imagem muito alta, ajustar pela largura
            width = maxWidth;
            height = width / targetRatio;
          }
          
          canvas.width = width;
          canvas.height = height;
          
          // Desenhar imagem redimensionada
          ctx.drawImage(img, 0, 0, width, height);
          
          // Comprimir com qualidade menor para arquivo mais leve
          callback(canvas.toDataURL("image/jpeg", 0.5));
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }

    // Validar campos obrigat√≥rios
    function validarCampos() {
      const placa = document.getElementById("placaVeiculo").value.trim();
      const kmInicial = document.getElementById("kmInicial").value;
      const kmFinal = document.getElementById("kmFinal").value;
      const fotoInicial = document.getElementById("fotoInicial").files[0];
      const fotoFinal = document.getElementById("fotoFinal").files[0];

      // Remover classes de erro anteriores
      document.querySelectorAll(\'.required\').forEach(el => el.classList.remove(\'required\'));

      let erros = [];

      if (!placa) {
        document.getElementById("placaVeiculo").classList.add(\'required\');
        erros.push("Placa do ve√≠culo √© obrigat√≥ria");
      }

      if (!kmInicial) {
        document.getElementById("kmInicial").classList.add(\'required\');
        erros.push("Quilometragem inicial √© obrigat√≥ria");
      }

      if (!kmFinal) {
        document.getElementById("kmFinal").classList.add(\'required\');
        erros.push("Quilometragem final √© obrigat√≥ria");
      }

      if (!fotoInicial) {
        document.getElementById("fotoInicial").classList.add(\'required\');
        erros.push("Foto inicial √© obrigat√≥ria");
      }

      if (!fotoFinal) {
        document.getElementById("fotoFinal").classList.add(\'required\');
        erros.push("Foto final √© obrigat√≥ria");
      }

      if (kmInicial && kmFinal && parseFloat(kmFinal) <= parseFloat(kmInicial)) {
        document.getElementById("kmFinal").classList.add(\'required\');
        erros.push("A quilometragem final deve ser maior que a inicial");
      }

      if (erros.length > 0) {
        alert("Por favor, corrija os seguintes erros:\n\n" + erros.join("\n"));
        return false;
      }

      return true;
    }

    // Atualizar lista de placas no filtro
    function atualizarFiltroPlacas() {
      const filtroPlaca = document.getElementById("filtroPlaca");
      const placasUnicas = [...new Set(registros.map(r => r.placa))].sort();
      
      // Limpar op√ß√µes existentes (exceto "Todas as placas")
      filtroPlaca.innerHTML = \'<option value="todas">Todas as placas</option>\';
      
      // Adicionar placas √∫nicas
      placasUnicas.forEach(placa => {
        const option = document.createElement("option");
        option.value = placa;
        option.textContent = placa;
        filtroPlaca.appendChild(option);
      });
    }

    // Atualizar m√©tricas
    function atualizarMetricas(dados) {
      const totalKm = dados.reduce((sum, r) => sum + r.kmPercorridos, 0);
      const mediaKm = dados.length > 0 ? totalKm / dados.length : 0;
      const totalViagens = dados.length;
      const maiorViagem = dados.length > 0 ? Math.max(...dados.map(r => r.kmPercorridos)) : 0;

      document.getElementById("totalKm").textContent = totalKm.toFixed(1);
      document.getElementById("mediaKm").textContent = mediaKm.toFixed(1);
      document.getElementById("totalViagens").textContent = totalViagens;
      document.getElementById("maiorViagem").textContent = maiorViagem.toFixed(1);
    }

    // Previews
    document.getElementById("fotoInicial").addEventListener(\'change\', e => {
      if (e.target.files[0]) {
        compressImage(e.target.files[0], (dataUrl) => {
          document.getElementById("previewInicial").src = dataUrl;
          document.getElementById("previewInicial").dataset.img = dataUrl;
          e.target.classList.remove(\'required\');
        });
      }
    });
    document.getElementById("fotoFinal").addEventListener(\'change\', e => {
      if (e.target.files[0]) {
        compressImage(e.target.files[0], (dataUrl) => {
          document.getElementById("previewFinal").src = dataUrl;
          document.getElementById("previewFinal").dataset.img = dataUrl;
          e.target.classList.remove(\'required\');
        });
      }
    });

    // Remover classe de erro ao digitar
    document.getElementById("placaVeiculo").addEventListener(\'input\', e => {
      e.target.classList.remove(\'required\');
      // Formatar placa automaticamente
      let valor = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, \'\');
      if (valor.length > 3) {
        valor = valor.substring(0, 3) + \'-\' + valor.substring(3, 7);
      }
      e.target.value = valor;
    });

    document.getElementById("kmInicial").addEventListener(\'input\', e => {
      e.target.classList.remove(\'required\');
    });

    document.getElementById("kmFinal").addEventListener(\'input\', e => {
      e.target.classList.remove(\'required\');
    });

    // Filtros de per√≠odo
    document.getElementById("filtroPer√≠odo").addEventListener(\'change\', function() {
      const valor = this.value;
      const dataInicio = document.getElementById("dataInicio");
      const dataFim = document.getElementById("dataFim");
      
      if (valor === "personalizado") {
        dataInicio.style.display = "block";
        dataFim.style.display = "block";
      } else {
        dataInicio.style.display = "none";
        dataFim.style.display = "none";
      }
    });

    // Fun√ß√£o auxiliar para converter data brasileira para objeto Date
    function parseDataBrasileira(dataStr) {
      if (!dataStr) return null;
      
      // Extrair apenas a parte da data (antes do espa√ßo, se houver)
      const datePart = dataStr.split(\' \')[0];
      
      // Verificar se est√° no formato dd/mm/yyyy
      const parts = datePart.split(\'/\');
      if (parts.length === 3) {
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1; // M√™s √© 0-indexado no JavaScript
        const year = parseInt(parts[2], 10);
        return new Date(year, month, day);
      }
      
      return null;
    }

    function aplicarFiltro() {
      const filtro = document.getElementById("filtroPer√≠odo").value;
      const placaFiltro = document.getElementById("filtroPlaca").value;
      const hoje = new Date();
      
      // Come√ßa com todos os registros carregados do Firestore
      let registrosParaFiltrar = [...registros];

      // Primeiro filtrar por per√≠odo
      let registrosFiltradosPorPeriodo = [];
      
      switch(filtro) {
        case "hoje":
          const hojeFmt = hoje.toLocaleDateString("pt-BR");
          registrosFiltradosPorPeriodo = registrosParaFiltrar.filter(r => {
            const recordDate = parseDataBrasileira(r.dataHora);
            return recordDate && recordDate.toLocaleDateString("pt-BR") === hojeFmt;
          });
          break;
        case "semana":
          const inicioSemana = new Date(hoje);
          inicioSemana.setDate(hoje.getDate() - hoje.getDay());
          inicioSemana.setHours(0,0,0,0);
          registrosFiltradosPorPeriodo = registrosParaFiltrar.filter(r => {
            const recordDate = parseDataBrasileira(r.dataHora);
            return recordDate && recordDate >= inicioSemana;
          });
          break;
        case "mes":
          const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
          registrosFiltradosPorPeriodo = registrosParaFiltrar.filter(r => {
            const recordDate = parseDataBrasileira(r.dataHora);
            return recordDate && recordDate >= inicioMes;
          });
          break;
        case "personalizado":
          const dataInicioStr = document.getElementById("dataInicio").value;
          const dataFimStr = document.getElementById("dataFim").value;
          if (dataInicioStr && dataFimStr) {
            const dataInicio = new Date(dataInicioStr + \'T00:00:00\');
            const dataFim = new Date(dataFimStr + \'T23:59:59\');
            registrosFiltradosPorPeriodo = registrosParaFiltrar.filter(r => {
              const recordDate = parseDataBrasileira(r.dataHora);
              return recordDate && recordDate >= dataInicio && recordDate <= dataFim;
            });
          } else {
            registrosFiltradosPorPeriodo = registrosParaFiltrar; // Se datas personalizadas n√£o forem preenchidas, n√£o filtra por per√≠odo
          }
          break;
        default:
          registrosFiltradosPorPeriodo = registrosParaFiltrar;
      }
      
      // Depois filtrar por placa
      if (placaFiltro !== "todas") {
        registrosFiltrados = registrosFiltradosPorPeriodo.filter(r => r.placa === placaFiltro);
      } else {
        registrosFiltrados = registrosFiltradosPorPeriodo;
      }
      
      console.log(`Filtro aplicado: ${filtro}, Placa: ${placaFiltro}, Registros encontrados: ${registrosFiltrados.length}`);
      
      renderizarRelatorios();
      atualizarDashboard();
      atualizarMetricas(registrosFiltrados);
    }

    // Renderizar relat√≥rios
    function renderizarRelatorios() {
      relatoriosDiv.innerHTML = "";
      if (registrosFiltrados.length === 0) {
        relatoriosDiv.innerHTML = \'<p style="text-align: center;">Nenhum registro encontrado para os filtros aplicados.</p>\';
        return;
      }
      registrosFiltrados.forEach((r) => {
        const div = document.createElement("div");
        div.className = "relatorio";
        div.innerHTML = `
          <div>
            <b>${r.placa} - ${r.dataHora}</b><br>
            Km Inicial: ${r.kmInicial} | Km Final: ${r.kmFinal} | Percorridos: <strong>${r.kmPercorridos.toFixed(1)} km</strong><br>
            <small>Usu√°rio: ${r.userEmail || \'N/A\'}</small><br>
            <img src="${r.fotoInicial}" alt="Inicial" class="foto-relatorio">
            <img src="${r.fotoFinal}" alt="Final" class="foto-relatorio">
          </div>
          <button onclick="deleteMileageRecord(\'${r.id}\')" class="btn-small btn-danger">üóëÔ∏è</button>
        `;
        relatoriosDiv.appendChild(div);
      });
    }

    // Fun√ß√µes de apagar adaptadas para Firestore
    function apagarRegistro(recordId) {
      deleteMileageRecord(recordId);
    }

    function apagarTodos() {
      deleteAllMileageRecords();
    }

    // Exportar XLSX
    function exportarXLSX() {
      const dadosExport = registrosFiltrados.map(r => ({
        "Placa": r.placa,
        "Data/Hora": r.dataHora,
        "Km Inicial": r.kmInicial,
        "Km Final": r.kmFinal,
        "Km Percorridos": r.kmPercorridos,
        "Usu√°rio": r.userEmail || \'N/A\'
      }));
      
      const ws = XLSX.utils.json_to_sheet(dadosExport);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Relat√≥rios");
      XLSX.writeFile(wb, "relatorios_quilometragem.xlsx");
    }

    // Dashboard com gr√°fico de linhas
    let chart;
    function atualizarDashboard() {
      const ctx = document.getElementById("grafico").getContext("2d");
      const labels = registrosFiltrados.map(r => r.dataHora ? r.dataHora.split(\' \')[0] : \'\');
      const kms = registrosFiltrados.map(r => r.kmPercorridos);

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Km Percorridos",
            data: kms,
            backgroundColor: "rgba(0,123,255,0.2)",
            borderColor: "rgba(0,123,255,1)",
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: "rgba(0,123,255,1)",
            pointBorderColor: "#fff",
            pointBorderWidth: 2,
            pointRadius: 5
          }]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: \'Quil√¥metros\'
              }
            },
            x: {
              title: {
                display: true,
                text: \'Data\'
              }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: \'top\'
            }
          }
        }
      });
    }

    // Altern√¢ncia de tema
    const themeToggle = document.getElementById("themeToggle");
    themeToggle.addEventListener(\'click\', () => {
      document.body.dataset.theme =
        document.body.dataset.theme === "dark" ? "light" : "dark";
      themeToggle.textContent = document.body.dataset.theme === "dark" ? "‚òÄÔ∏è" : "üåô";
      localStorage.setItem("theme", document.body.dataset.theme);
    });

    // Carregar tema salvo
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme) {
      document.body.dataset.theme = savedTheme;
      themeToggle.textContent = savedTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
    }

    // Registrar Service Worker
    if (\'serviceWorker\' in navigator) {
      window.addEventListener(\'load\', () => {
        navigator.serviceWorker.register(\'service-worker.js\')
          .then((registration) => {
            console.log(\'SW registrado com sucesso: \', registration);
          })
          .catch((registrationError) => {
            console.log(\'SW falhou ao registrar: \', registrationError);
          });
      });
    }
  </script>
</body>
</html>

