<!DOCTYPE html>
<html lang="pt-BR">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#003366">
<link rel="icon" href="icon-192.png" type="image/png">
<link rel="apple-touch-icon" href="icon-192.png">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Quilometragem</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- XLSX (Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg: #f7f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted:#6b7280;
      --primary:#2563eb;
      --border:#e5e7eb;
      --grid: rgba(0,0,0,.08);
    }
    [data-theme="dark"]{
      --bg:#101216;
      --card:#171a21;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --primary:#60a5fa;
      --border:#252a33;
      --grid: rgba(255,255,255,.12);
    }

    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      line-height:1.35;
    }
    .container{max-width:980px;margin:0 auto;padding:16px}
    h1{margin:14px 0 10px;text-align:center;font-size:1.5rem}
    h2{margin:8px 0 14px;font-size:1.1rem;text-align:center}
    .card{
      background:var(--card);border:1px solid var(--border);
      border-radius:14px; padding:14px; margin:12px 0 18px;
      box-shadow:0 6px 18px rgba(0,0,0,.05);
    }
    label{display:block;margin:8px 0 6px;font-weight:600;font-size:.95rem}
    input,select,textarea{
      width:100%;padding:10px 12px;border:1px solid var(--border);
      border-radius:10px;background:transparent;color:var(--text);font-size:.95rem;
      outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:var(--primary)}
    textarea{min-height:80px;resize:vertical}

    /* Bot√µes compactos */
    .actions{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-start}
    .btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;font-size:.9rem;font-weight:700;
      background:var(--primary);color:#fff;border:0;border-radius:10px;
      cursor:pointer;transition:transform .1s ease,opacity .2s ease;
    }
    .btn:hover{opacity:.9;transform:translateY(-1px)}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
    .btn.small{padding:6px 10px;font-weight:600}

    img.preview{max-width:120px;border-radius:8px;margin-top:6px;border:1px solid var(--border)}

    /* Relat√≥rios */
    .relatorio{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      padding:10px;border:1px solid var(--border);border-radius:10px;margin-top:10px;flex-wrap:wrap;
      background:var(--card);
    }
    .relatorio-info{font-size:.92rem}
    .relatorio img{max-height:80px}

    /* Dashboard */
    .filters{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px}
    .filters select{flex:1;min-width:160px}
    .metrics{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-bottom:12px}
    .metric{
      border:1px solid var(--border);border-radius:12px;padding:10px;text-align:center;background:var(--card)
    }
    .metric h3{margin:0;color:var(--muted);font-size:.9rem;font-weight:700}
    .metric p{margin:6px 0 0;color:var(--primary);font-size:1.25rem;font-weight:800}

    canvas{width:100%!important;height:300px!important}

    /* Bot√£o de contraste fixo, apenas √≠cone */
    .theme-toggle{
      position:fixed;top:10px;right:10px;z-index:9999;
      background:transparent;border:none;color:var(--text);
      font-size:22px;cursor:pointer;padding:0;line-height:1;
    }
    .theme-toggle:hover{opacity:.7}

    @media (max-width:640px){
      .metrics{grid-template-columns:1fr}
      .actions{justify-content:stretch}
      .btn{flex:1}
    }
  </style>
</head>
<body>
<div style="text-align:center; margin-top:10px;"><button id="adminBtn" style="display:none;" onclick="openAdminPanel()">Administra√ß√£o</button></div>
<style>
  #btnSairApp{
    position: fixed;
    top: 10px;
    left: 10px;
    z-index: 10000;
    background: rgba(0,0,0,0.6);
    color: #fff;
    border: none;
    border-radius: 999px;
    padding: 6px 10px;
    font-size: 12px;
    line-height: 1;
    cursor: pointer;
    display: none;
  }
  #btnSairApp:hover{ opacity: .9; }
</style>
<button id="btnSairApp" title="Sair">Sair</button>

<div id="appRoot" hidden>

  <!-- Bot√£o de contraste -->
  <button id="themeToggle" class="theme-toggle" aria-label="Alternar tema">üåô</button>

  <div class="container">
    <h1>Controle de Quilometragem</h1>

    <!-- Novo Registro -->
    <div class="card">
      <h2>Novo Registro</h2>

      <div class="grid">
        <label>Data e Hora (Bras√≠lia):</label>
        <input type="text" id="dataHora" readonly />
      </div>

      <label>Placa do Ve√≠culo *</label>
      <input type="text" id="placa" placeholder="Ex: ABC-1234" />

      <label>Quilometragem Inicial *</label>
      <input type="number" id="kmInicial" inputmode="numeric" />

      <label>Foto Inicial *</label>
      <input type="file" id="fotoInicial" accept="image/*" />
      <img id="previewInicial" class="preview" alt="Pr√©via inicial" />

      <label>Quilometragem Final *</label>
      <input type="number" id="kmFinal" inputmode="numeric" />

      <label>Foto Final *</label>
      <input type="file" id="fotoFinal" accept="image/*" />
      <img id="previewFinal" class="preview" alt="Pr√©via final" />

      <label>Observa√ß√£o (opcional)</label>
      <textarea id="observacao" placeholder="Algo a acrescentar?"></textarea>

      <div class="actions">
        <button class="btn small" id="btnSalvar">üíæ Salvar</button>
      </div>
    </div>

    <!-- Relat√≥rios -->
    <div class="card">
      <h2>Relat√≥rios</h2>
      <div id="relatorios"></div>
      <div class="actions" style="margin-top:8px">
        <button class="btn small" id="btnExportar">üìÇ Exportar XLSX</button>
        <button class="btn small ghost" id="btnApagar">üóëÔ∏è Apagar Todos</button>
      </div>
    </div>

    <!-- Dashboard -->
    <div class="card">
      <h2>Dashboard</h2>

      <div class="filters">
        <select id="periodo">
          <option value="todos">Todos os registros</option>
          <option value="semana">√öltima semana</option>
          <option value="mes">√öltimo m√™s</option>
          <option value="ano">√öltimo ano</option>
        </select>
        <select id="filtroPlaca">
          <option value="todas">Todas as placas</option>
        </select>
      </div>

      <div class="metrics">
        <div class="metric"><h3>Total Km</h3><p id="totalKm">0</p></div>
        <div class="metric"><h3>M√©dia Km</h3><p id="mediaKm">0</p></div>
        <div class="metric"><h3>Registros</h3><p id="numRegistros">0</p></div>
      </div>

      <canvas id="grafico"></canvas>
    </div>
  </div>

  <script>
    // ===== Estado =====
    let registros = JSON.parse(localStorage.getItem("registros") || "[]");
    let chart;

    // ===== Utilidades =====
    function nowBR(){
      const opt = { timeZone:"America/Sao_Paulo", hour12:false };
      return new Date().toLocaleString("pt-BR", opt);
    }
    function parseDataHoraBR(str){
      const m = (str||"").match(/(\d{2})\/(\d{2})\/(\d{4}).*?(\d{2}):(\d{2})(?::(\d{2}))?/);
      if(!m) return null;
      const [, dd, MM, yyyy, HH, mm, ss] = m;
      return new Date(`${yyyy}-${MM}-${dd}T${HH}:${mm}:${ss||"00"}`);
    }
    function compressImage(file, cb){
      const reader = new FileReader();
      reader.onload = e=>{
        const img = new Image();
        img.onload = ()=>{
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          const maxW = 700;
          const scale = Math.min(maxW / img.width, 1);
          canvas.width = img.width * scale;
          canvas.height = img.height * scale;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          cb(canvas.toDataURL("image/jpeg", 0.75));
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    function showOk(title, text){
      Swal.fire({icon:"success", title, text, timer:1800, showConfirmButton:false});
    }
    function showErr(text){
      Swal.fire({icon:"error", title:"Aten√ß√£o", text});
    }

    // ===== Tema claro/escuro =====
    const themeBtn = document.getElementById("themeToggle");
    function updateThemeIcon(){
      themeBtn.textContent = document.body.dataset.theme === "dark" ? "‚òÄÔ∏è" : "üåô";
    }
    themeBtn.addEventListener("click", ()=>{
      document.body.dataset.theme = document.body.dataset.theme === "dark" ? "light" : "dark";
      updateThemeIcon();
      atualizarDashboard();
    });
    // Estado inicial tema
    document.body.dataset.theme = "light";
    updateThemeIcon();

    // ===== Inputs e eventos =====
    const dataHoraInput = document.getElementById("dataHora");
    const placaInput    = document.getElementById("placa");
    const kmIniInput    = document.getElementById("kmInicial");
    const kmFimInput    = document.getElementById("kmFinal");
    const fotoIniInput  = document.getElementById("fotoInicial");
    const fotoFimInput  = document.getElementById("fotoFinal");
    const obsInput      = document.getElementById("observacao");
    const filtroPeriodo = document.getElementById("periodo");
    const filtroPlaca   = document.getElementById("filtroPlaca");
    const relatoriosDiv = document.getElementById("relatorios");

    // Atualiza rel√≥gio
    function tick(){ dataHoraInput.value = nowBR(); }
    setInterval(tick, 1000); tick();

    // Previews
    fotoIniInput.addEventListener("change", e=>{
      const f = e.target.files[0]; if(!f) return;
      compressImage(f, url=>{
        document.getElementById("previewInicial").src = url;
        document.getElementById("previewInicial").dataset.img = url;
      });
    });
    fotoFimInput.addEventListener("change", e=>{
      const f = e.target.files[0]; if(!f) return;
      compressImage(f, url=>{
        document.getElementById("previewFinal").src = url;
        document.getElementById("previewFinal").dataset.img = url;
      });
    });

    document.getElementById("btnSalvar").addEventListener("click", salvarRegistro);
    document.getElementById("btnExportar").addEventListener("click", exportarXLSX);
    document.getElementById("btnApagar").addEventListener("click", apagarTodos);
    filtroPeriodo.addEventListener("change", atualizarDashboard);
    filtroPlaca.addEventListener("change", atualizarDashboard);

    // ===== CRUD =====
    function validar(){
      const placa = (placaInput.value||"").trim().toUpperCase();
      const kmI = parseFloat(kmIniInput.value);
      const kmF = parseFloat(kmFimInput.value);
      const fotoI = document.getElementById("previewInicial").dataset.img;
      const fotoF = document.getElementById("previewFinal").dataset.img;

      if(!placa) return showErr("Informe a placa do ve√≠culo.");
      if(!Number.isFinite(kmI)) return showErr("Informe a quilometragem inicial.");
      if(!Number.isFinite(kmF)) return showErr("Informe a quilometragem final.");
      if(kmF < kmI) return showErr("A quilometragem final deve ser maior ou igual √† inicial.");
      if(!fotoI) return showErr("Anexe a foto inicial.");
      if(!fotoF) return showErr("Anexe a foto final.");
      return {placa, kmI, kmF, fotoI, fotoF};
    }

    function salvarRegistro(){
      const ok = validar();
      if(!ok) return;

      const registro = {
        dataHora: dataHoraInput.value,
        placa: ok.placa,
        kmInicial: ok.kmI,
        kmFinal: ok.kmF,
        fotoInicial: ok.fotoI,
        fotoFinal: ok.fotoF,
        observacao: (obsInput.value||"").trim()
      };

      registros.push(registro);
      localStorage.setItem("registros", JSON.stringify(registros));
      renderizarRelatorios();
      atualizarDashboard();
      showOk("Registro salvo", "Seu registro foi adicionado com sucesso.");

      // limpar campos
      placaInput.value = "";
      kmIniInput.value = "";
      kmFimInput.value = "";
      fotoIniInput.value = "";
      fotoFimInput.value = "";
      obsInput.value = "";
      document.getElementById("previewInicial").src = ""; delete document.getElementById("previewInicial").dataset.img;
      document.getElementById("previewFinal").src = ""; delete document.getElementById("previewFinal").dataset.img;
    }

    function apagarTodos(){
      if(registros.length === 0){
        showErr("N√£o h√° registros para apagar."); return;
      }
      Swal.fire({
        icon:"warning", title:"Apagar todos?", text:"Esta a√ß√£o n√£o pode ser desfeita.",
        showCancelButton:true, confirmButtonText:"Apagar", cancelButtonText:"Cancelar"
      }).then(res=>{
        if(res.isConfirmed){
          registros = [];
          localStorage.removeItem("registros");
          renderizarRelatorios();
          atualizarDashboard();
          showOk("Registros apagados", "Todos os registros foram removidos.");
        }
      });
    }

    function exportarXLSX(){
      if(registros.length === 0){
        showErr("N√£o h√° registros para exportar."); return;
      }
      const data = registros.map(r=>({
        "Data/Hora": r.dataHora,
        "Placa": r.placa,
        "Km Inicial": r.kmInicial,
        "Km Final": r.kmFinal,
        "Km Rodado": (r.kmFinal - r.kmInicial),
        "Observa√ß√£o": r.observacao || ""
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Relat√≥rios");
      XLSX.writeFile(wb, "relatorios.xlsx");
      showOk("Arquivo gerado", "Planilha Excel exportada com sucesso.");
    }

    // ===== UI =====
    function renderizarRelatorios(){
      relatoriosDiv.innerHTML = "";
      registros.forEach((r,i)=>{
        const el = document.createElement("div");
        el.className = "relatorio";
        el.innerHTML = `
          <div class="relatorio-info">
            <b>${r.dataHora}</b><br/>
            Placa: ${r.placa}<br/>
            Km Inicial: ${r.kmInicial} | Km Final: ${r.kmFinal} | <b>Rodado: ${r.kmFinal - r.kmInicial}</b><br/>
            ${r.observacao ? `Obs.: ${r.observacao}<br/>` : ""}
            <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">
              ${r.fotoInicial ? `<img src="${r.fotoInicial}" alt="Inicial" />` : ""}
              ${r.fotoFinal ? `<img src="${r.fotoFinal}" alt="Final" />` : ""}
            </div>
          </div>
          <button class="btn small ghost" onclick="apagarRegistro(${i})">üóëÔ∏è Apagar</button>
        `;
        relatoriosDiv.appendChild(el);
      });
      atualizarFiltroPlacas();
    }

    function apagarRegistro(i){
      registros.splice(i,1);
      localStorage.setItem("registros", JSON.stringify(registros));
      renderizarRelatorios();
      atualizarDashboard();
      showOk("Registro removido","O registro foi apagado.");
    }

    function atualizarFiltroPlacas(){
      const sel = document.getElementById("filtroPlaca");
      const atual = sel.value;
      const placas = [...new Set(registros.map(r=>r.placa).filter(Boolean))];
      sel.innerHTML = `<option value="todas">Todas as placas</option>`;
      placas.forEach(p=>{
        const o = document.createElement("option");
        o.value = p; o.textContent = p; sel.appendChild(o);
      });
      if([...sel.options].some(o=>o.value===atual)) sel.value = atual;
    }

    function getChartColors(){
      const cs = getComputedStyle(document.body);
      return {
        text: cs.getPropertyValue('--text').trim(),
        grid: cs.getPropertyValue('--grid').trim()
      };
    }

    function atualizarDashboard(){
      let filtrados = [...registros];

      // per√≠odo
      const per = filtroPeriodo.value;
      const agora = new Date();
      filtrados = filtrados.filter(r=>{
        const dt = parseDataHoraBR(r.dataHora) || new Date();
        const dias = (agora - dt)/86400000;
        if(per==="semana") return dias<=7;
        if(per==="mes")    return dias<=30;
        if(per==="ano")    return dias<=365;
        return true;
      });

      // placa
      const placaSel = filtroPlaca.value;
      if(placaSel !== "todas") filtrados = filtrados.filter(r=>r.placa===placaSel);

      const labels = filtrados.map(r=>r.dataHora);
      const kms = filtrados.map(r=>(+r.kmFinal || 0) - (+r.kmInicial || 0));

      // m√©tricas
      const total = kms.reduce((a,b)=>a+(Number.isFinite(b)?b:0),0);
      const media = kms.length ? total / kms.length : 0;
      document.getElementById("totalKm").textContent = Math.round(total);
      document.getElementById("mediaKm").textContent = media.toFixed(1);
      document.getElementById("numRegistros").textContent = filtrados.length;

      // gr√°fico
      const ctx = document.getElementById("grafico").getContext("2d");
      const {text, grid} = getChartColors();
      const maxY = kms.length ? Math.max(...kms) : 0;

      if(chart) chart.destroy();
      chart = new Chart(ctx,{
        type:"line",
        data:{
          labels,
          datasets:[{
            label:"Km Percorridos",
            data:kms,
            borderColor:"rgba(37,99,235,1)",
            backgroundColor:"rgba(37,99,235,0.18)",
            fill:true,tension:.3,pointRadius:4,pointHoverRadius:6
          }]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ labels:{ color:text, font:{size:12} } },
                    tooltip:{ titleColor:text, bodyColor:text } },
          scales:{
            x:{ ticks:{ color:text, maxRotation:0, autoSkip:true },
                grid:{ color:grid } },
            y:{ beginAtZero:true,
                suggestedMax: maxY>0 ? maxY + Math.ceil(maxY*0.15)+5 : 10,
                ticks:{ color:text }, grid:{ color:grid } }
          }
        }
      });
    }

    // ===== Inicializa√ß√£o =====
    renderizarRelatorios();
    atualizarDashboard();
  </script>

</div>

<style>
  .auth-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.08);backdrop-filter:saturate(150%) blur(2px);z-index:9999}
  .auth-card{width:100%;max-width:380px;background:var(--card-bg,#fff);color:var(--text-color,#111);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:20px}
  .auth-title{margin:0 0 8px;font-size:20px}
  .auth-sub{margin:0 0 16px;font-size:13px;opacity:.8}
  .auth-input{width:100%;padding:10px 12px;border:1px solid #d0d7de;border-radius:10px;margin:6px 0 10px;font-size:14px}
  .auth-btn{width:100%;padding:10px;border:none;border-radius:10px;cursor:pointer;font-weight:600;margin-top:8px}
  .auth-primary{background:#0d47a1;color:#fff}
  .auth-secondary{background:#e9eef7}
  .auth-row{display:flex;gap:8px}
  .auth-row .auth-btn{flex:1}
  @media (max-width:420px){.auth-card{margin:8px;padding:16px;border-radius:14px}}
</style>
<div id="authScreen" class="auth-overlay" aria-hidden="false">
  <div class="auth-card">
    <h3 class="auth-title">Entrar no Controle de KM</h3>
    <p class="auth-sub">Use seu e-mail e senha. Se ainda n√£o tem, cadastre-se.</p>
    <input id="authEmail" class="auth-input" type="email" placeholder="Seu e-mail" autocomplete="email" required>
    <input id="authPass" class="auth-input" type="password" placeholder="Sua senha" autocomplete="current-password" required>
    <button id="btnEntrar" class="auth-btn auth-primary">Entrar</button>
    <div class="auth-row">
      <button id="btnCadastrar" class="auth-btn auth-secondary">Cadastrar</button>
      <button id="btnEsqueci" class="auth-btn auth-secondary">Esqueci a senha</button>
    </div>
    <div id="authMsg" class="auth-sub" style="margin-top:10px;color:#d32f2f;display:none;"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCNUTWw3BLTg3S2KPqsnCfZC_aw5lqidas",
  authDomain: "controle-de-km-86510.firebaseapp.com",
  projectId: "controle-de-km-86510",
  storageBucket: "controle-de-km-86510.firebasestorage.app",
  messagingSenderId: "608090510388",
  appId: "1:608090510388:web:3b31393fb0a80ba243a661",
  measurementId: "G-HW52GZV66K"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

function $(sel){ return document.querySelector(sel); }
const authScreen = $('#authScreen');
const appRoot    = $('#appRoot');
const msgBox     = $('#authMsg');

function showAuthMessage(text, isWarn=false){
  if(!msgBox) return;
  msgBox.style.display = 'block';
  msgBox.style.color = isWarn ? '#d32f2f' : '#2e7d32';
  msgBox.textContent = text;
}
function hideAuthMessage(){ if(msgBox){ msgBox.style.display='none'; msgBox.textContent=''; } }

function getDeviceId(){
  try{
    let id = localStorage.getItem('deviceId');
    if(!id){
      id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : 'dev-' + Math.random().toString(36).slice(2);
      localStorage.setItem('deviceId', id);
    }
    return id;
  }catch(e){ return 'dev-' + Math.random().toString(36).slice(2); }
}
const DEVICE_ID = getDeviceId();
let sessionUnsub = null;

async function bindSingleDeviceSession(user){
  if(!user) return;
  const ref = db.collection('userSessions').doc(user.uid);
  await ref.set({
    deviceId: DEVICE_ID,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });

  if (sessionUnsub) sessionUnsub();
  sessionUnsub = ref.onSnapshot(snap => {
    const data = snap.data();
    if (!data) return;
    if (data.deviceId && data.deviceId !== DEVICE_ID) {
      auth.signOut().catch(()=>{});
      showAuthMessage('Sua conta foi acessada em outro dispositivo. Voc√™ foi desconectado aqui.', true);
    }
  });
}

function traduzErro(e){
  const code = e?.code || '';
  if (code.includes('auth/invalid-email')) return 'E-mail inv√°lido.';
  if (code.includes('auth/user-not-found')) return 'Usu√°rio n√£o encontrado.';
  if (code.includes('auth/wrong-password')) return 'Senha incorreta.';
  if (code.includes('auth/email-already-in-use')) return 'Este e-mail j√° est√° em uso.';
  if (code.includes('auth/weak-password')) return 'Senha fraca. Tente outra.';
  return 'Erro: ' + (e?.message || 'tente novamente.');
}

$('#btnEntrar')?.addEventListener('click', async () => {
  hideAuthMessage();
  const email = $('#authEmail').value.trim();
  const pass  = $('#authPass').value;
  if(!email || !pass) return showAuthMessage('Preencha e-mail e senha.', true);
  try{
    const cred = await auth.signInWithEmailAndPassword(email, pass);
    if (!cred.user.emailVerified) {
      await auth.signOut();
      return showAuthMessage('Verifique seu e-mail antes de acessar o app.', true);
    }
    showAuthMessage('Login realizado!');
  }catch(e){ showAuthMessage(traduzErro(e), true); }
});

$('#btnCadastrar')?.addEventListener('click', async () => {
  hideAuthMessage();
  const email = $('#authEmail').value.trim();
  const pass  = $('#authPass').value;
  if(!email || !pass) return showAuthMessage('Informe e-mail e crie uma senha.', true);
  try{
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    await cred.user.sendEmailVerification();
    await auth.signOut();
    showAuthMessage('Conta criada! Enviamos um e-mail de verifica√ß√£o. Confirme para entrar.', false);
  }catch(e){ showAuthMessage(traduzErro(e), true); }
});

$('#btnEsqueci')?.addEventListener('click', async () => {
  hideAuthMessage();
  const email = $('#authEmail').value.trim();
  if(!email) return showAuthMessage('Digite seu e-mail para receber o link.', true);
  try{
    await auth.sendPasswordResetEmail(email);
    showAuthMessage('Enviamos um link de redefini√ß√£o para seu e-mail.');
  }catch(e){ showAuthMessage(traduzErro(e), true); }
});

auth.onAuthStateChanged(async (user) => {
  if (user) {
    await user.reload();
    if (!user.emailVerified) {
      if (appRoot) appRoot.hidden = true;
      if (authScreen) authScreen.style.display = 'flex';
      showAuthMessage('Verifique seu e-mail antes de acessar o app.', true);
      await auth.signOut();
      return;
    }
    await bindSingleDeviceSession(user);
    if (appRoot) appRoot.hidden = false;
    if (authScreen) authScreen.style.display = 'none';
  } else {
    if (appRoot) appRoot.hidden = true;
    if (authScreen) authScreen.style.display = 'flex';
    if (sessionUnsub) { sessionUnsub(); sessionUnsub = null; }
  }
});

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(()=>console.log('SW registrado'))
    .catch(err=>console.log('Falha SW', err));
}
</script>

<script>
(function(){
  function whenFirebase(cb){
    if (window.firebase && firebase.auth) return cb();
    setTimeout(function(){ whenFirebase(cb); }, 80);
  }
  whenFirebase(async function(){
    try {
      if (firebase.auth && firebase.auth.Auth && firebase.auth.Auth.Persistence) {
        await firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(function(){});
      }
    } catch(e){ console.log('persistencia local falhou', e); }

    var auth = firebase.auth();
    var appRoot = document.querySelector('#appRoot');
    var authScreen = document.querySelector('#authScreen');
    var btnSair = document.querySelector('#btnSairApp');

    function showApp(){
      if (appRoot) appRoot.hidden = false;
      if (authScreen) authScreen.style.display = 'none';
      if (btnSair) btnSair.style.display = 'inline-flex';
    }
    function showLogin(){
      if (appRoot) appRoot.hidden = true;
      if (authScreen) authScreen.style.display = 'flex';
      if (btnSair) btnSair.style.display = 'none';
    }

    auth.onAuthStateChanged(async function(user){
      try{
        if (!user) { showLogin(); return; }
        await user.reload();
        if (user.emailVerified) showApp();
        else showLogin();
      }catch(e){ console.log('onAuthStateChanged erro', e); }
    });

    var btnEntrar = document.querySelector('#btnEntrar');
    if (btnEntrar) {
      btnEntrar.addEventListener('click', function(){
        var tries = 0;
        var iv = setInterval(function(){
          var u = auth.currentUser;
          if (u && u.emailVerified) { showApp(); clearInterval(iv); }
          if (++tries > 40) clearInterval(iv); // ~3.2s
        }, 80);
      });
    }

    if (btnSair) {
      btnSair.addEventListener('click', function(){
        auth.signOut().catch(function(e){ console.log('logout erro', e); }).finally(function(){ showLogin(); });
      });
    }
  });
})();
</script>

<!-- Painel de Administra√ß√£o -->
<div id="adminPanel" style="display:none; padding:20px;">
  <h2>Gerenciar Usu√°rios</h2>
  <table border="1" cellpadding="5" cellspacing="0" style="width:100%;">
    <thead>
      <tr><th>Nome</th><th>Email</th><th>Status</th><th>A√ß√£o</th></tr>
    </thead>
    <tbody id="userList"></tbody>
  </table>
</div>
<script>
// Verificar se √© admin
firebase.auth().onAuthStateChanged((user) => {
  if (user && user.email === 'alansrocha@gmail.com') {
    document.getElementById('adminBtn').style.display = 'inline-block';
  }
});
// Abrir painel
function openAdminPanel() {
  document.getElementById('adminPanel').style.display = 'block';
  loadUsers();
}

// Carregar lista de usu√°rios
async function loadUsers() {
  const snapshot = await firebase.firestore().collection('users').get();
  const tbody = document.getElementById('userList');
  tbody.innerHTML = '';
  snapshot.forEach(doc => {
    const data = doc.data();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${data.name || ''}</td>
      <td>${data.email}</td>
      <td>${data.revoked ? 'Revogado' : 'Ativo'}</td>
      <td>
        <button onclick="toggleAccess('${doc.id}', ${!data.revoked})">
          ${data.revoked ? 'Restaurar' : 'Revogar'}
        </button>
      </td>`;
    tbody.appendChild(tr);
  });
}

// Alternar acesso
async function toggleAccess(uid, revoke) {
  await firebase.firestore().collection('users').doc(uid).update({ revoked: revoke });
  loadUsers();
}
</script>

</body>
</html>
